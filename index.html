<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ANK YUKTI – Mental Math Challenge</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    .screen {
      display: none;
      padding: 20px;
    }

    .screen.active {
      display: block;
    }

    h1 {
      margin-top: 20px;
      font-size: 32px;
    }

    h2 {
      margin-top: 10px;
      font-size: 22px;
    }

    input {
      padding: 10px;
      font-size: 18px;
      width: 80%;
      max-width: 320px;
      margin: 8px 0;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 12px 22px;
      margin: 10px;
      border-radius: 8px;
      border: none;
      font-size: 18px;
      background: #28a745;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #grid {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    .box {
      display: inline-block;
      width: 90px;
      height: 60px;
      background: #222;
      border-radius: 10px;
      font-size: 22px;
      line-height: 60px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .box.selected {
      background: #3a7bd5;
    }

    .box.cleared {
      visibility: hidden;    /* box gayab, lekin jagah wahi rehti hai */
      cursor: default;
    }

    #topBar {
      margin-top: 10px;
      font-size: 18px;
    }

    #topBar span {
      margin: 0 6px;
    }

    #recaptcha-container {
      margin: 10px auto;
      display: inline-block;
    }

    .small-note {
      font-size: 13px;
      color: #ccc;
      margin-top: 6px;
    }

    .footer {
      margin-top: 30px;
      font-size: 13px;
      color: #777;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="screen active">
    <h1>ANK YUKTI</h1>
    <h2>Login with Mobile Number</h2>

    <input
      id="phoneInput"
      type="text"
      placeholder="Enter mobile (e.g. 88240xxxxx)"
    /><br />

    <div id="recaptcha-container"></div><br />

    <button id="sendOtpBtn">Send OTP</button>

    <div id="otpArea" style="display:none; margin-top:10px;">
      <input
        id="otpInput"
        type="text"
        placeholder="Enter OTP"
      /><br />
      <button id="verifyOtpBtn">Verify OTP</button>
    </div>

    <div class="small-note">
      Daily free SMS limit Firebase test mode ke hisaab se hoti hai.
    </div>
  </div>

  <!-- MODE SCREEN (abhi single mode: Master Speed) -->
  <div id="modeScreen" class="screen">
    <h1>ANK YUKTI</h1>
    <h2>Select Mode</h2>
    <button id="startMasterBtn">Start Master Speed</button>
    <div class="small-note">
      Aapki last saved progress isi number se sabhi devices par same rahegi.
    </div>
    <button id="logoutBtn" style="background:#c0392b;">Logout</button>
  </div>

  <!-- GAME SCREEN -->
  <div id="gameScreen" class="screen">
    <h1 id="gameTitle">Master</h1>
    <h2 id="gameSubTitle">Master · Level 1 / 100000</h2>

    <div id="topBar">
      <span id="timeLabel">Time left: 40 s</span> |
      <span id="scoreLabel">Score: 0</span>
    </div>

    <div id="grid"></div>

    <div style="margin-top:20px;">
      <button id="backToModesBtn" style="background:#555;">Back</button>
      <button id="restartLevelBtn" style="background:#3498db;">Restart Level</button>
    </div>
    <div class="footer">
      Match ek expression aur uske answer ko.<br />
      Pair sahi hote hi dono boxes gayab ho jayenge, par grid ki jagah same rahegi.
    </div>
  </div>

  <!-- FIREBASE + GAME LOGIC -->
  <script type="module">
    // ---------- Firebase imports ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      RecaptchaVerifier,
      signInWithPhoneNumber,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDvmE4Qodn5awQzla0TAfcmjShgy1eaNnc",
      authDomain: "ankyukti.firebaseapp.com",
      projectId: "ankyukti",
      storageBucket: "ankyukti.firebasestorage.app",
      messagingSenderId: "888009326878",
      appId: "1:888009326878:web:2038a8453c05a99d1f090f"
    };

    // ---------- Initialize Firebase ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- DOM refs ----------
    const loginScreen = document.getElementById("loginScreen");
    const modeScreen = document.getElementById("modeScreen");
    const gameScreen = document.getElementById("gameScreen");

    const phoneInput = document.getElementById("phoneInput");
    const sendOtpBtn = document.getElementById("sendOtpBtn");
    const otpArea = document.getElementById("otpArea");
    const otpInput = document.getElementById("otpInput");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");

    const startMasterBtn = document.getElementById("startMasterBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const gameTitle = document.getElementById("gameTitle");
    const gameSubTitle = document.getElementById("gameSubTitle");
    const timeLabel = document.getElementById("timeLabel");
    const scoreLabel = document.getElementById("scoreLabel");
    const gridEl = document.getElementById("grid");
    const backToModesBtn = document.getElementById("backToModesBtn");
    const restartLevelBtn = document.getElementById("restartLevelBtn");

    // ---------- screen helper ----------
    function showScreen(screen) {
      loginScreen.classList.remove("active");
      modeScreen.classList.remove("active");
      gameScreen.classList.remove("active");
      screen.classList.add("active");
    }

    // ---------- Auth + progress state ----------
    let recaptchaVerifier = null;
    let confirmationResultGlobal = null;
    let currentUserPhone = null;

    const MODE_NAME = "Master";
    const DIFFICULTY_NAME = "Speed";

    let cloudProgress = {};  // { "Master_Speed": { bestLevel: number } }

    function progressKey(mode, diff) {
      return `${mode}_${diff}`;
    }

    function getBestLevel(mode, diff) {
      const key = progressKey(mode, diff);
      if (cloudProgress[key] && cloudProgress[key].bestLevel) {
        return cloudProgress[key].bestLevel;
      }
      return 1;
    }

    async function updateBestLevel(mode, diff, newLevel) {
      const key = progressKey(mode, diff);
      const old = cloudProgress[key]?.bestLevel || 1;
      if (newLevel <= old) return;  // sirf increase hone par hi save

      cloudProgress[key] = { bestLevel: newLevel };
      if (!currentUserPhone) return;

      try {
        const userDocRef = doc(db, "users", currentUserPhone);
        await setDoc(
          userDocRef,
          { progress: { ...cloudProgress } },
          { merge: true }
        );
        console.log("Progress saved:", cloudProgress);
      } catch (err) {
        console.error("Error saving progress:", err);
      }
    }

    async function loadUserProgress(phoneNumber) {
      currentUserPhone = phoneNumber;
      const userDocRef = doc(db, "users", phoneNumber);
      try {
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          const data = snap.data();
          cloudProgress = data.progress || {};
        } else {
          cloudProgress = {};
          await setDoc(userDocRef, { progress: {} });
        }
        console.log("Loaded progress:", cloudProgress);
      } catch (err) {
        console.error("Error loading progress:", err);
        cloudProgress = {};
      }
    }

    // ---------- OTP Flow ----------
    function setupRecaptcha() {
      if (!recaptchaVerifier) {
        recaptchaVerifier = new RecaptchaVerifier(
          auth,
          "recaptcha-container",
          {
            size: "normal",
            callback: () => {
              console.log("reCAPTCHA solved");
            }
          }
        );
      }
    }

    sendOtpBtn.addEventListener("click", async () => {
      let raw = phoneInput.value.trim();
      if (!raw) {
        alert("Please enter mobile number");
        return;
      }
      // simple India default
      if (!raw.startsWith("+")) {
        raw = "+91" + raw;
      }

      setupRecaptcha();

      try {
        sendOtpBtn.disabled = true;
        confirmationResultGlobal = await signInWithPhoneNumber(
          auth,
          raw,
          recaptchaVerifier
        );
        otpArea.style.display = "block";
        alert("OTP sent!");
      } catch (err) {
        console.error(err);
        alert("Error sending OTP: " + (err.message || ""));
        sendOtpBtn.disabled = false;
      }
    });

    verifyOtpBtn.addEventListener("click", async () => {
      const otp = otpInput.value.trim();
      if (!otp || !confirmationResultGlobal) {
        alert("Enter OTP first.");
        return;
      }

      try {
        verifyOtpBtn.disabled = true;
        const result = await confirmationResultGlobal.confirm(otp);
        const user = result.user;
        const phoneNumber = user.phoneNumber;

        await loadUserProgress(phoneNumber);

        otpInput.value = "";
        showScreen(modeScreen);
      } catch (err) {
        console.error(err);
        alert("OTP verification failed: " + (err.message || ""));
        verifyOtpBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
      }
      currentUserPhone = null;
      cloudProgress = {};
      phoneInput.value = "";
      otpInput.value = "";
      otpArea.style.display = "none";
      sendOtpBtn.disabled = false;
      verifyOtpBtn.disabled = false;
      showScreen(loginScreen);
    });

    // ---------- GAME LOGIC ----------
    let currentLevel = 1;
    let score = 0;
    let timeLeft = 0;
    let timerId = null;

    let gridData = [];   // { displayText, valueNumber, matched }
    let boxes = [];      // DOM elements
    let firstIndex = null;
    let secondIndex = null;
    let clickLock = false;
    let matchedCount = 0;

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // pairs generate: expression + answer
    function generatePairs() {
      const pairs = [];
      for (let i = 0; i < 15; i++) {
        const a = randomInt(2, 40 + currentLevel);  // level ke sath thoda tough
        const b = randomInt(2, 12);
        const opIndex = randomInt(1, 4); // 1:+ 2:- 3:* 4:/
        let expr = "";
        let value = 0;

        switch (opIndex) {
          case 1:
            expr = `${a} + ${b}`;
            value = a + b;
            break;
          case 2:
            // minus me negative avoid
            const big = Math.max(a, b);
            const small = Math.min(a, b);
            expr = `${big} - ${small}`;
            value = big - small;
            break;
          case 3:
            expr = `${a} × ${b}`;
            value = a * b;
            break;
          case 4:
            // division integer rakhenge
            value = a;
            const mul = a * b;
            expr = `${mul} ÷ ${b}`;
            break;
        }

        // do cards is pair ke:
        pairs.push({
          displayText: expr,
          valueNumber: value,
          matched: false
        });
        pairs.push({
          displayText: String(value),
          valueNumber: value,
          matched: false
        });
      }

      // shuffle
      for (let i = pairs.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
      }

      return pairs;
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      boxes = [];
      gridData.forEach((item, index) => {
        const btn = document.createElement("div");
        btn.className = "box";
        btn.textContent = item.displayText;
        btn.addEventListener("click", () => handleBoxClick(index));
        boxes.push(btn);
        gridEl.appendChild(btn);
      });
    }

    function resetSelections() {
      if (firstIndex !== null && boxes[firstIndex]) {
        boxes[firstIndex].classList.remove("selected");
      }
      if (secondIndex !== null && boxes[secondIndex]) {
        boxes[secondIndex].classList.remove("selected");
      }
      firstIndex = null;
      secondIndex = null;
      clickLock = false;
    }

    function handleBoxClick(index) {
      if (clickLock) return;
      const item = gridData[index];
      if (!item || item.matched) return;

      if (firstIndex === null) {
        firstIndex = index;
        boxes[index].classList.add("selected");
        return;
      }

      if (index === firstIndex) return; // same box

      if (secondIndex === null) {
        secondIndex = index;
        boxes[index].classList.add("selected");
      }

      const firstItem = gridData[firstIndex];
      const secondItem = gridData[secondIndex];

      clickLock = true;

      if (firstItem.valueNumber === secondItem.valueNumber) {
        // Match!
        setTimeout(() => {
          firstItem.matched = true;
          secondItem.matched = true;
          boxes[firstIndex].classList.add("cleared");
          boxes[secondIndex].classList.add("cleared");
          matchedCount += 2;
          score += 10;
          scoreLabel.textContent = "Score: " + score;
          resetSelections();

          if (matchedCount === gridData.length) {
            levelCompleted();
          }
        }, 200);
      } else {
        // Galat match
        setTimeout(() => {
          resetSelections();
        }, 300);
      }
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function startTimer() {
      stopTimer();
      timeLeft = 40; // fixed 40 seconds, chaho to level ke sath change kar sakte ho
      timeLabel.textContent = "Time left: " + timeLeft + " s";

      timerId = setInterval(() => {
        timeLeft--;
        if (timeLeft < 0) timeLeft = 0;
        timeLabel.textContent = "Time left: " + timeLeft + " s";
        if (timeLeft <= 0) {
          stopTimer();
          alert("Time over! Same level se dobara try karein.");
          startLevel(currentLevel); // same level
        }
      }, 1000);
    }

    function levelCompleted() {
      stopTimer();
      alert("Level " + currentLevel + " complete! Next level...");
      currentLevel++;
      updateBestLevel(MODE_NAME, DIFFICULTY_NAME, currentLevel);
      startLevel(currentLevel);
    }

    function startLevel(levelNumber) {
      currentLevel = levelNumber;
      matchedCount = 0;
      firstIndex = null;
      secondIndex = null;
      clickLock = false;

      gameTitle.textContent = "Master";
      gameSubTitle.textContent =
        "Master · Level " + currentLevel + " / 100000";
      scoreLabel.textContent = "Score: " + score;

      gridData = generatePairs();
      renderGrid();
      startTimer();
      window.scrollTo(0, 0);
    }

    startMasterBtn.addEventListener("click", () => {
      // user ki cloud progress se starting level
      const startLevelNum = getBestLevel(MODE_NAME, DIFFICULTY_NAME);
      score = 0;
      showScreen(gameScreen);
      startLevel(startLevelNum);
    });

    backToModesBtn.addEventListener("click", () => {
      stopTimer();
      showScreen(modeScreen);
    });

    restartLevelBtn.addEventListener("click", () => {
      stopTimer();
      startLevel(currentLevel);
    });
  </script>
</body>
</html>
